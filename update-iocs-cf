#!/bin/sh

die() {
  echo "$1" >&2
  exit 1
}

. /etc/default/epics-softioc

[ -d /etc/conserver ] || exit 0

tmp=$(tempfile) || die "Failed to create tempfile"

echo "## Generated by update-iocs-cf" > "$tmp"

manage-iocs report '' conserver >> "$tmp" || die "Failed to generate config"

if mv -f "$tmp" "${IOCSCF:=/etc/conserver/iocs.cf}"
then
    chmod a+r "${IOCSCF:=/etc/conserver/iocs.cf}"
    # poke daemon to reread config files
    if type invoke-rc.d 2>&1 >/dev/null; then
        invoke-rc.d conserver-server reload
    else
        /etc/init.d/conserver-server reload
    fi
else
    echo "Could not update /etc/conserver/iocs.cf"
fi

rm -f "$tmp"
